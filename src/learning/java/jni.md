# Java Native Interface

## Sample

```java
public class HelloJni {
    static {
        System.loadLibrary("hello");
    }

    private native void sayHello();

    public static void main(String[] args) {
        new HelloJni().sayHello();
    }
}
```

Generate `*.h` file with cmd `javac -h . .\cn.az.code.jni\HelloJni.java`

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class cn_az_code_jni_HelloJni */

#ifndef _Included_cn_az_code_jni_HelloJni
#define _Included_cn_az_code_jni_HelloJni
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     cn_az_code_jni_HelloJni
 * Method:    sayHello
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_cn_az_code_jni_HelloJni_sayHello
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

Write own impl

```c
#include <jni.h>
#include <stdio.h>
#include <hello-jni.h>

JNIEXPORT void JNICALL Java_cn_az_code_jni_HelloJni_sayHello(JNIEnv *env, jobject thisObj) {
    printf("hello world!\n");
    return;
}
```

## 一些定义

### Windows 平台宏定义

```c
#ifndef _JAVASOFT_JNI_MD_H_
#define _JAVASOFT_JNI_MD_H_

#define JNIEXPORT __declspec(dllexport)
#define JNIIMPORT __declspec(dllimport)
#define JNICALL __stdcall

typedef long jint;
typedef __int64 jlong;
typedef signed char jbyte;

#endif /* !_JAVASOFT_JNI_MD_H_ */
```

### Linux 平台宏定义

```c
#define JNIIMPORT
#define JNIEXPORT  __attribute__ ((visibility ("default")))
#define JNICALL
```

### JNIEXPORT

保证在本动态库中声明的方法，能够在其他项目中可以被调用

**Windows**：需要将方法返回值之前加入 `__declspec(dllexport) 标识`

**Linux**：需要将方法返回值之前加入 `attribute((visibility("default")))` 标识

### JNICALL

**Windows**：JNICALL 被定义为 `__stdcall`，`__stdcall` 是一种函数调用参数的约定，在 Windows 中调用函数时，该函数的参数是以栈的形式保存的，栈中元素是后进先出的，`__stdcall` 表示参数是从右到左保存的

**Linux**：JNICALL 没有进行订阅，可以不用写 JNIEXPORT 和 JNICALL 宏

### Windows 平台宏替换

```c
extern "C"
JNIEXPORT void JNICALL
Java_jniTest
    (JNIEnv* env, jobject instance, jint i, jstring s_) {
}

// 编译器，替换后
extern "C"
__declspec(dllexport) void __stdcall
Java_jniTest
    (JNIEnv* env, jobject instance, jint i, jstring s_) {
}
```

### Linux 平台宏替换

```c
extern "C"
JNIEXPORT void JNICALL
Java_jniTest
    (JNIEnv* env, jobject instance, jint i, jstring s_) {
}

// 编译器替换后
extern "C"
__attribute__ ((visibility ("default"))) 
void 
Java_jniTest
    (JNIEnv* env, jobject instance, jint i, jstring s_) {
}
```

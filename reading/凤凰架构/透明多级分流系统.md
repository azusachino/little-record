# 透明多级分流系统

最简单的系统就是最好的系统。

客户端缓存、域名解析、传输链路、内容分发网络、负载均衡、服务端缓存

## 客户端缓存

状态缓存是指不经过服务器，客户端直接根据缓存信息对目标网站的状态判断。

### 强制缓存

假设某个时间点到来之前，比如收到响应后的 10 分钟内，资源的内容和状态一定不会被改变，因此客户端可以无需经过任何请求，在该时点前一直持有该资源的本地缓存副本。

强制缓存在浏览器的地址输入、页面链接跳转、新开窗口、前进和后退中均可生效，但在用户主动刷新页面时应当自动失效。

**Expires**:

当服务器返回某个资源时带有该 Header，意味着服务器承诺资源在截止时间之前不会发生变动，浏览器可直接缓存该数据，不再重新发请求

1. 受限于客户端的本地时间
2. 无法处理涉及用户身份的私有资源
3. 无法描述"不缓存"的语义

**Cache-Control**:

Cache-Control 是 HTTP/1.1 协议中定义的强制缓存 Header，它的语义比 Expires 丰富了很多，如果 Cache-Control 和 Expires 同时存在，并且语义存在冲突（譬如 Expires 与 max-age/s-maxage 冲突）的话，规定必须以 Cache-Control 为准。

1. max-age & s-maxage
2. public & private
3. no-cache & no-store
4. no-transform
5. min-fresh & only-if-cached
6. must-revalidate & proxy-revalidate

### 协商缓存

1. Last-Modified&If-Modified-Since
2. ETag & If-None-Match

## 域名解析

1. 客户端先检查本地的 DNS 缓存，查看是否存在存活着的该域名的地址记录。
2. 客户端将地址发送给本机操作系统中配置的本地 DNS
3. 本地 DNS 收到查询请求后，会按照“是否有www.icyfenix.com.cn的权威服务器”→“是否有icyfenix.com.cn的权威服务器”→“是否有com.cn的权威服务器”→“是否有cn的权威服务器”的顺序，依次查询自己的地址记录，如果都没有查询到，就会一直找到最后点号代表的根域名服务器为止。
4. 现在假设本地 DNS 是全新的，上面不存在任何域名的权威服务器记录，所以当 DNS 查询请求按步骤 3 的顺序一直查到根域名服务器之后，它将会得到“cn 的权威服务器”的地址记录，然后通过“cn 的权威服务器”，得到“com.cn 的权威服务器”的地址记录，以此类推，最后找到能够解释“www.icyfenix.com.cn”的权威服务器地址。
5. 通过“www.icyfenix.com.cn的权威服务器”，查询www.icyfenix.com.cn的地址记录。地址记录并不一定就是指IP地址，在RFC规范中有定义的地址记录类型已经多达数十种，譬如IPv4下的IP地址为A记录，IPv6下的AAAA记录、主机别名CNAME记录，等等。

- 权威域名服务器（Authoritative DNS）：负责翻译特定域名的 DNS 服务器，“权威”意味着域名应该翻译出怎样的结果是由这个服务器决定的。
- 根域名服务器（Root DNS）：固定的、无须查询的顶级域名（Top-LevelDomain）服务器，可以默认它们已内置在操作系统代码之中。

## 传输链路

1. 减少请求数量
2. 扩大并发请求数
3. 启用压缩传输
4. 避免页面重定向
5. 按重要性调节资源优先级

## 内容分发网络(CDN)

### 路由解析

### 内容分发

### CDN 应用

- 加速静态资源分发
- 安全防御
- 协议升级
- 状态缓存
- 修改资源
- 访问控制
- 注入功能

## 负载均衡

### 数据链路层

数据链路层传输的内容是数据帧（Frame），譬如常见的以太网帧、ADSL 宽带的 PPP 帧等。

### 网络层

### 应用层

### 均衡策略和实现

- Round Robin
- Weighted Round Robin
- Random
- Weighted Random
- Consistency Hash
- Response Time
- Least Connection

## 服务端缓存

- 吞吐量
- 命中率
- 拓展功能
- 分布式缓存

---

- FIFO
- LRU
- LFU
- TinyLFU
- W-TinyLFU

---

- 加载器
- 淘汰策略
- 失效策略
- 事件通知
- 并发级别
- 容量控制
- 引用方式
- 统计信息
- 持久化

---

- 缓存穿透
- 缓存击穿
- 缓存雪崩
- 缓存污染
